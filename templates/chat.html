{% extends "base.html" %}

{% block title %}Global Chat{% endblock %}

{% block head %}
<style>
    .chat-box {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
        border-radius: 0.75rem; /* More rounded corners */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); /* Subtle shadow */
    }
    .list-group-item {
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease; /* Added transform for subtle effect */
        border: none; /* Remove default border */
        margin-bottom: 2px; /* Space between items */
        border-radius: 0.5rem; /* Rounded corners for list items */
    }
    .list-group-item:hover {
        background-color: #e0f7fa; /* Lighter pastel blue on hover */
        transform: translateX(3px); /* Subtle slide effect on hover */
    }
    .chat-message {
        padding: 10px 15px; /* Slightly more padding */
        margin-bottom: 10px; /* More space between messages */
        border-radius: 1.2rem; /* More rounded message bubbles */
        max-width: 75%; /* Slightly narrower messages */
        word-wrap: break-word;
        font-size: 0.95rem; /* Slightly larger font */
        line-height: 1.4;
    }
    .chat-message.sent {
        background-color: #e6ee9c; /* Pastel lime green for sent messages */
        margin-left: auto;
        text-align: left; /* Align text left within the bubble */
        border-bottom-right-radius: 0.3rem; /* Pointy corner for sent */
    }
    .chat-message.received {
        background-color: #ffffff; /* White for received messages */
        border: 1px solid #cfd8dc; /* Light grey border */
        text-align: left;
        border-bottom-left-radius: 0.3rem; /* Pointy corner for received */
    }
    .chat-message .username {
        font-weight: bold;
        margin-bottom: 5px; /* More space below username */
        display: block;
        color: #546e7a; /* Darker grey for username */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-center" style="color: #66bb6a;"><i class="fas fa-comments me-2"></i>Real-time Global Chat</h1> <!-- Pastel green heading -->

    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8"> <!-- Centered and wider column for chat -->
            <div class="card shadow-lg mb-4" style="border-radius: 1rem; border: none;"> <!-- Larger shadow and rounded card -->
                <div class="card-header bg-gradient-primary text-white text-center py-3" style="border-top-left-radius: 1rem; border-top-right-radius: 1rem; background-image: linear-gradient(to right, #80cbc4, #a7ffeb);"> <!-- Pastel gradient header -->
                    <h5 class="mb-0">Online Users & Chat Rooms</h5>
                </div>
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-4 border-end">
                            <div class="p-3">
                                <h6 class="text-info mb-3">Online Users</h6>
                                <ul class="list-group list-group-flush" id="online-users">
                                    <!-- Online users will be listed here -->
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-4 border-end">
                            <div class="p-3">
                                <h6 class="text-success mb-3">Global Chat Rooms</h6>
                                <ul class="list-group list-group-flush" id="global-chat-rooms">
                                    <!-- Global chat rooms will be listed here -->
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3">
                                <h6 class="text-warning mb-3">Team Chat Rooms</h6>
                                <ul class="list-group list-group-flush" id="team-chat-rooms">
                                    <!-- Team chat rooms will be listed here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg" style="border-radius: 1rem; border: none;"> <!-- Main chat card -->
                <div class="card-header bg-gradient-info text-white py-3" id="chat-header" style="border-top-left-radius: 1rem; border-top-right-radius: 1rem; background-image: linear-gradient(to right, #80deea, #b2ebf2);">Select a chat to begin</div> <!-- Pastel gradient header -->
                <div class="card-body chat-box" id="chat-box">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="card-footer bg-light py-3" style="border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control form-control-lg" placeholder="Type your message..." style="border-radius: 0.75rem 0 0 0.75rem; border-color: #b2ebf2;">
                        <button class="btn btn-primary btn-lg" id="send-button" style="background-color: #80cbc4; border-color: #80cbc4; border-radius: 0 0.75rem 0.75rem 0;">Send</button> <!-- Pastel green send button -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var socket = io();
        var currentRoomId = '{{ current_room_id if current_room_id else "general" }}';
        var currentRoomName = '{{ current_room_name if current_room_name else "Global Chat" }}'; // Default name, will be updated on room join
        var currentRoomType = '{{ current_room_type if current_room_type else "global" }}'; // Default room type, now passed from backend

        // Function to display a single message
        function displayMessage(username, message, isCurrentUser) {
            var chatBox = document.getElementById('chat-box');
            var messageElement = document.createElement('div');
            messageElement.className = 'chat-message ' + (isCurrentUser ? 'sent' : 'received');
            messageElement.innerHTML = '<span class="username">' + username + ':</span> ' + message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
        }

        // Function to join a room
        function joinRoom(roomId, roomName, roomType) {
            if (currentRoomId) {
                socket.emit('leave_room', { room_id: currentRoomId, room_type: currentRoomType });
            }
            currentRoomId = roomId;
            currentRoomName = roomName;
            currentRoomType = roomType; // Update current room type
            document.getElementById('chat-header').textContent = 'Chat: ' + roomName;
            document.getElementById('chat-box').innerHTML = ''; // Clear previous messages

            socket.emit('join_room', { room_id: roomId, room_type: roomType });
            console.log('Joining room:', roomName, '(', roomId, ') of type:', roomType);

            // Update URL to reflect current room
            var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room_id=' + roomId + '&room_type=' + roomType;
            window.history.pushState({path:newurl}, '', newurl);
        }

        // Handle connection and disconnection
        socket.on('connect', function() {
            console.log('Connected to chat server!');
            // Request list of online users and chat rooms upon connection
            socket.emit('request_online_users');
            socket.emit('request_chat_rooms', {});
            // Join the initial room (either from URL or default 'general')
            joinRoom(currentRoomId, currentRoomName, currentRoomType);
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from chat server!');
        });

        // Handle receiving historical messages
        socket.on('historical_messages', function(messages) {
            messages.forEach(function(message) {
                displayMessage(message.sender_username, message.message, message.sender_id === '{{ current_user.get_id() }}');
            });
        });

        // Handle receiving online users list
        socket.on('online_users', function(users) {
            var onlineUsersList = document.getElementById('online-users');
            onlineUsersList.innerHTML = '';
            users.forEach(function(user) {
                var li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = user.username + (user.id === '{{ current_user.get_id() }}' ? ' <span class="badge bg-secondary rounded-pill">You</span>' : '');
                onlineUsersList.appendChild(li);
            });
        });

        // Handle receiving chat rooms list
        socket.on('chat_rooms', function(rooms) {
            var globalChatRoomsList = document.getElementById('global-chat-rooms');
            var teamChatRoomsList = document.getElementById('team-chat-rooms');
            globalChatRoomsList.innerHTML = '';
            teamChatRoomsList.innerHTML = '';

            rooms.forEach(function(room) {
                var li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = room.name;
                li.dataset.roomId = room.id;
                li.dataset.roomType = room.type; // Assuming room object has a 'type' property

                li.addEventListener('click', function() {
                    joinRoom(room.id, room.name, room.type);
                });

                if (room.type === 'global') {
                    globalChatRoomsList.appendChild(li);
                } else if (room.type === 'team') {
                    teamChatRoomsList.appendChild(li);
                }
            });
        });

        // Handle receiving messages
        socket.on('receive_message', function(data) {
            // Only display message if it belongs to the currently active room
            if (data.room_id === currentRoomId) {
                displayMessage(data.username, data.message, data.sender_id === '{{ current_user.get_id() }}');
            }
        });

        // Handle status messages (e.g., user joined/left)
        socket.on('status_message', function(data) {
            if (data.room_id === currentRoomId) {
                var chatBox = document.getElementById('chat-box');
                var messageElement = document.createElement('div');
                messageElement.className = 'text-muted text-center my-2';
                messageElement.textContent = data.msg;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
            }
        });

        // Send message on button click
        document.getElementById('send-button').addEventListener('click', function() {
            var messageInput = document.getElementById('message-input');
            var message = messageInput.value;
            if (message.trim() !== '' && currentRoomId) {
                socket.emit('send_message', { message: message, room_id: currentRoomId, room_type: currentRoomType, username: '{{ current_user.name if current_user.is_authenticated else "Anonymous" }}', sender_id: '{{ current_user.get_id() if current_user.is_authenticated else "" }}' });
                messageInput.value = '';
            } else if (!currentRoomId) {
                alert('Please select a chat room to send messages.');
            }
        });

        // Send message on Enter key press
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-button').click();
            }
        });
    });
</script>
{% endblock %}