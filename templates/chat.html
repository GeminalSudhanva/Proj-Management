{% extends "base.html" %}

{% block title %}Global Chat{% endblock %}

{% block head %}
<style>
    .chat-box {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
    }
    .list-group-item {
        cursor: pointer;
    }
    .list-group-item:hover {
        background-color: #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Real-time Global Chat</h1>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Online Users</div>
                <ul class="list-group list-group-flush" id="online-users">
                    <!-- Online users will be listed here -->
                </ul>
            </div>
            <div class="card">
                <div class="card-header">Global Chat Rooms</div>
                <ul class="list-group list-group-flush" id="global-chat-rooms">
                    <!-- Global chat rooms will be listed here -->
                </ul>
            </div>
            <div class="card mt-3">
                <div class="card-header">Team Chat Rooms</div>
                <ul class="list-group list-group-flush" id="team-chat-rooms">
                    <!-- Team chat rooms will be listed here -->
                </ul>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header" id="chat-header">Select a chat to begin</div>
                <div class="card-body chat-box" id="chat-box">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
                        <button class="btn btn-primary" id="send-button">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var socket = io();
        var currentRoomId = '{{ current_room_id if current_room_id else "general" }}';
        var currentRoomName = '{{ current_room_name if current_room_name else "Global Chat" }}'; // Default name, will be updated on room join
        var currentRoomType = '{{ current_room_type if current_room_type else "global" }}'; // Default room type, now passed from backend

        // Function to display a single message
        function displayMessage(username, message) {
            var chatBox = document.getElementById('chat-box');
            var messageElement = document.createElement('div');
            messageElement.textContent = username + ': ' + message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
        }

        // Function to join a room
        function joinRoom(roomId, roomName, roomType) {
            if (currentRoomId) {
                socket.emit('leave_room', { room_id: currentRoomId, room_type: currentRoomType });
            }
            currentRoomId = roomId;
            currentRoomName = roomName;
            currentRoomType = roomType; // Update current room type
            document.getElementById('chat-header').textContent = 'Chat: ' + roomName;
            document.getElementById('chat-box').innerHTML = ''; // Clear previous messages

            socket.emit('join_room', { room_id: roomId, room_type: roomType });
            console.log('Joining room:', roomName, '(', roomId, ') of type:', roomType);

            // Update URL to reflect current room
            var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room_id=' + roomId + '&room_type=' + roomType;
            window.history.pushState({path:newurl}, '', newurl);
        }

        // Handle connection and disconnection
        socket.on('connect', function() {
            console.log('Connected to chat server!');
            // Request list of online users and chat rooms upon connection
            socket.emit('request_online_users');
            socket.emit('request_chat_rooms', {});
            // Join the initial room (either from URL or default 'general')
            joinRoom(currentRoomId, currentRoomName, currentRoomType);
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from chat server!');
        });

        // Handle receiving historical messages
        socket.on('historical_messages', function(messages) {
            messages.forEach(function(message) {
                displayMessage(message.sender_username, message.message);
            });
        });

        // Handle receiving online users list
        socket.on('online_users', function(users) {
            var onlineUsersList = document.getElementById('online-users');
            onlineUsersList.innerHTML = '';
            users.forEach(function(user) {
                var li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = user.username + (user.id === '{{ current_user.get_id() }}' ? ' (You)' : '');
                onlineUsersList.appendChild(li);
            });
        });

        // Handle receiving chat rooms list
        socket.on('chat_rooms', function(rooms) {
            var globalChatRoomsList = document.getElementById('global-chat-rooms');
            var teamChatRoomsList = document.getElementById('team-chat-rooms');
            globalChatRoomsList.innerHTML = '';
            teamChatRoomsList.innerHTML = '';

            rooms.forEach(function(room) {
                var li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = room.name;
                li.dataset.roomId = room.id;
                li.dataset.roomType = room.type; // Assuming room object has a 'type' property

                li.addEventListener('click', function() {
                    joinRoom(room.id, room.name, room.type);
                });

                if (room.type === 'global') {
                    globalChatRoomsList.appendChild(li);
                } else if (room.type === 'team') {
                    teamChatRoomsList.appendChild(li);
                }
            });
        });

        // Handle receiving messages
        socket.on('receive_message', function(data) {
            // Only display message if it belongs to the currently active room
            if (data.room_id === currentRoomId) {
                var chatBox = document.getElementById('chat-box');
                var messageElement = document.createElement('div');
                messageElement.textContent = data.username + ': ' + data.message;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
            }
        });

        // Handle status messages (e.g., user joined/left)
        socket.on('status_message', function(data) {
            if (data.room_id === currentRoomId) {
                var chatBox = document.getElementById('chat-box');
                var messageElement = document.createElement('div');
                messageElement.className = 'text-muted';
                messageElement.textContent = data.msg;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
            }
        });

        // Send message on button click
        document.getElementById('send-button').addEventListener('click', function() {
            var messageInput = document.getElementById('message-input');
            var message = messageInput.value;
            if (message.trim() !== '' && currentRoomId) {
                socket.emit('send_message', { message: message, room_id: currentRoomId, room_type: currentRoomType, username: '{{ current_user.name if current_user.is_authenticated else "Anonymous" }}' });
                messageInput.value = '';
            } else if (!currentRoomId) {
                alert('Please select a chat room to send messages.');
            }
        });

        // Send message on Enter key press
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-button').click();
            }
        });
    });
</script>
{% endblock %}