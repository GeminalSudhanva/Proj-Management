{% extends "base.html" %}

{% block title %}Team Chat{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Real-time Team Chat</h1>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Online Users</div>
                <ul class="list-group list-group-flush" id="online-users">
                    <!-- Online users will be listed here -->
                </ul>
            </div>
            <div class="card">
                <div class="card-header">Chat Rooms</div>
                <ul class="list-group list-group-flush" id="chat-rooms">
                    <!-- Chat rooms will be listed here -->
                </ul>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header" id="chat-header">Select a chat to begin</div>
                <div class="card-body chat-box" id="chat-box">
                    <!-- Chat messages will appear here -->
                    {% for message in historical_messages %}
                    <div>{{ message.username }}: {{ message.message }}</div>
                    {% endfor %}
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
                        <button class="btn btn-primary" id="send-button">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var socket = io();

        // Handle connection and disconnection
        socket.on('connect', function() {
            console.log('Connected to chat server!');
            // Request list of online users and chat rooms upon connection
            socket.emit('request_online_users');
            socket.emit('request_chat_rooms');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from chat server!');
        });

        // Handle receiving online users list
        socket.on('online_users', function(users) {
            var onlineUsersList = document.getElementById('online-users');
            onlineUsersList.innerHTML = '';
            users.forEach(function(user) {
                var li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = user.username + (user.id === '{{ current_user.get_id() }}' ? ' (You)' : '');
                onlineUsersList.appendChild(li);
            });
        });

        // Handle receiving chat rooms list
        socket.on('chat_rooms', function(rooms) {
            var chatRoomsList = document.getElementById('chat-rooms');
            chatRoomsList.innerHTML = '';
            rooms.forEach(function(room) {
                var li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = room.name;
                li.dataset.roomId = room.id; // Store room ID for joining
                li.addEventListener('click', function() {
                    // Logic to join a room
                    console.log('Joining room:', room.name);
                    // socket.emit('join_room', {room_id: room.id});
                });
                chatRoomsList.appendChild(li);
            });
        });

        // Handle receiving messages
        socket.on('receive_message', function(data) {
            var chatBox = document.getElementById('chat-box');
            var messageElement = document.createElement('div');
            messageElement.textContent = data.username + ': ' + data.message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
        });

        // Send message on button click
        document.getElementById('send-button').addEventListener('click', function() {
            var messageInput = document.getElementById('message-input');
            var message = messageInput.value;
            if (message.trim() !== '') {
                socket.emit('send_message', {message: message, username: '{{ current_user.name if current_user.is_authenticated else "Anonymous" }}'});
                messageInput.value = '';
            }
        });

        // Send message on Enter key press
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-button').click();
            }
        });
    });
</script>
{% endblock %}

{% block head %}
<style>
    .chat-box {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
    }
    .list-group-item {
        cursor: pointer;
    }
    .list-group-item:hover {
        background-color: #f0f0f0;
    }
</style>
{% endblock %}